defmodule GodwokenExplorerWeb.API.BlockControllerTest do
  use GodwokenExplorer, :schema
  use GodwokenExplorerWeb.ConnCase

  setup do
    Repo.insert(%Account{
      id: 0,
      nonce: 0,
      script_hash: "0x5c84fc6078725df72052cc858dffc6f352a069706c9023a82eeff3b2a1a9ccd1",
      short_address: "0x5c84fc6078725df72052cc858dffc6f352a06970",
      type: :meta_contract
    })

    {:ok, block} =
      Block.create_block(%{
        hash: "0x9e449451846827df40c9a8bcb2809256011afbbf394de676d52535c3ca32a518",
        parent_hash: "0xa04ecc2bb1bc634848535b60b3223c1cd5278aa93abb2c138687da8ffa9ffd48",
        number: 14,
        timestamp: ~U[2021-10-31 05:39:38.000000Z],
        status: :finalized,
        aggregator_id: 0,
        transaction_count: 1,
        gas_limit: D.new(12500000),
        gas_used: D.new(0),
        size: 156,
        logs_bloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        layer1_block_number: "2345241",
        layer1_tx_hash: "0xae12080b62ec17acc092b341a6ca17da0708e7a6d77e8033c785ea48cdbdbeef"
      })

    block
    |> Ecto.Changeset.change(%{
      inserted_at: NaiveDateTime.truncate(~U[2021-10-31 05:39:38.000000Z], :second)
    })
    |> Repo.update()
    :ok
  end

  describe "show" do
    test "when block exist", %{conn: conn} do
      conn =
        get(
          conn,
          Routes.block_path(conn, :show, "0x9e449451846827df40c9a8bcb2809256011afbbf394de676d52535c3ca32a518")
        )

      assert json_response(conn, 200) ==
        %{
          "hash" => "0x9e449451846827df40c9a8bcb2809256011afbbf394de676d52535c3ca32a518",
          "number" => 14,
          "l1_block" => 2345241,
          "l1_tx_hash" => "0xae12080b62ec17acc092b341a6ca17da0708e7a6d77e8033c785ea48cdbdbeef",
          "finalize_state" => "finalized",
          "tx_count" => 1,
          "miner_hash" => "0x5c84fc6078725df72052cc858dffc6f352a06970",
          "timestamp" => 1635658778,
          "gas_limit" => "12500000",
          "gas_used" => "0",
          "size" => 156,
          "parent_hash" => "0xa04ecc2bb1bc634848535b60b3223c1cd5278aa93abb2c138687da8ffa9ffd48",
          "logs_bloom" => "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
        }
    end
  end
end
